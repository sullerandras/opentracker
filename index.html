<html>
  <head>
    <script src="https://cdn.firebase.com/v0/firebase.js"></script>
    <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase-simple-login.js">
    </script>
    <!--
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.1.5/angular.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angularFire/0.2.0/angularfire.min.js"></script>
    -->
    <script src="angular.min.js"></script>
    <script src="angularfire.js"></script>
  </head>
  <body ng-app="opentrackerapp" ng-controller="AppCtrl">
    <a href ng-click="signin('github')" ng-if="!user">Sign in with Github</a>
    <div ng-if="user">
      Welcome, {{user.displayName}}!
      <a href ng-click="signout()">Sign out</a>
    </div>
    <ul>
      <li ng-repeat="(id, project) in projects">{{project.name}}: {{project.desc}}</li>
    </ul>
    <form ng-submit="add(project)">
      <input type="text" ng-model="project.name" placeholder="Name" required/>
      <input type="text" ng-model="project.desc" placeholder="Description"/>
      <button type="submit">Submit</button>
    </form>
    project:
    <pre>{{project | json}}</pre>
    projects:
    <pre>{{projects | json}}</pre>
    user:
    <pre>{{user | json}}</pre>
    <script>
      var url = 'https://opentracker.firebaseio.com';
      var app = angular.module('opentrackerapp', ['firebase']);
      app.controller('AppCtrl', ['$scope', 'angularFire', 'angularFireAuth',
        function AppCtrl(scope, angularFire, angularFireAuth) {
          window.scope = scope
          scope.signin = function(id){
            angularFireAuth.login(id)
          }
          scope.signout = function(id){
            angularFireAuth.logout()
          }
          scope.add = function(project){
            var project_id = 'p' + scope.auth_user.id + '_' + (Object.keys(scope.projects).length + 1)
            scope.project.creator_id = scope.auth_user.id
            scope.project.id = project_id
            new Firebase(url+'/projects/'+project_id).set(scope.project, function(error){
              console.log('message from server:', error)
              safeApply(function(){
                scope.user.projects.push(project_id)
                scope.project = {}
                associateProject(project_id)
              })
            });
            // angularFire(url+'/projects/234', scope, 'new_project', {}).then(function(result){
            //   console.log('angular message from server:', result)
            //   scope.new_project = scope.project
            //   scope.project = {}
            // });
          }
          scope.escape = function(str){
            return str.replace(/\./g, '_')
          }
          function safeApply(fn) {
            window.setTimeout(function(){
              (scope.$$phase || scope.$root.$$phase) ? fn() : scope.$apply(fn);
            })
          }
          function associateProject(project_id){
            angularFire(url+'/projects/'+project_id, scope, project_id, {}).then(function(result){
              scope.projects[project_id] = scope[project_id]
            })
          }
          scope.project = {}
          scope.projects = {}

          angularFireAuth.initialize(url, {name: 'auth_user'})
          scope.$watch('auth_user', function(){
            if (scope.auth_user) {
              var path = url+'/users/'+scope.auth_user.id
              angularFire(path, scope, 'user', {}).then(function(result){
                scope.disassociate_user = result
                if (scope.user == {}) {
                  safeApply(function(){
                    scope.user.email       = scope.auth_user.email
                    scope.user.displayName = scope.auth_user.displayName
                    scope.user.name        = scope.auth_user.name
                  })
                }
                if (!scope.user.projects) {
                  scope.user.projects = []
                }
                scope.user.projects.forEach(function(project_id){
                  associateProject(project_id)
                })
              });
            } else {
              if (scope.disassociate_user) scope.disassociate_user()
              scope.user = null
            }
          })
        }
      ]);
    </script>
  </body>
</html>
